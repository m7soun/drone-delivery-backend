# Drone Delivery Backend

NestJS backend for managing drone deliveries. Built with TypeScript, PostgreSQL, and JWT authentication.

## Quick Start

```bash
git clone <repository-url>
cd drone-delivery-backend
make setup
make up
make seed
```

API running at http://localhost:3000

## What's Inside

- JWT authentication with role-based access (Admin, User, Drone)
- Order management with real-time tracking
- Drone fleet management
- Automatic order handoff when drones fail
- Bruno API collection ready to use
- 54 tests included

## Tech Stack

- NestJS 10 + TypeScript 5
- PostgreSQL 15 + Prisma ORM
- Docker & Docker Compose
- Jest for testing
- Swagger docs at `/api`

## Setup Options

### Option 1: Makefile (recommended)

```bash
make setup    # creates .env and generates JWT secret
make up       # starts everything
make seed     # adds test data
make logs     # view logs
make down     # stop everything
```

### Option 2: Docker Compose

```bash
cp .env.example .env
SECRET=$(openssl rand -base64 64 | tr -d '\n') && sed -i.bak "s|^JWT_SECRET=.*|JWT_SECRET=$SECRET|" .env && rm -f .env.bak
docker-compose up -d
docker-compose exec app npm run seed
```

### Option 3: Without Docker

```bash
cp .env.example .env
SECRET=$(openssl rand -base64 64 | tr -d '\n') && sed -i.bak "s|^JWT_SECRET=.*|JWT_SECRET=$SECRET|" .env && rm -f .env.bak
npm install
npx prisma migrate deploy
npm run seed
npm run start:dev
```

## Testing the API

### Bruno (easiest)

1. Download Bruno from https://www.usebruno.com
2. Open the `bruno-collection` folder
3. Select "Local" environment
4. Run any request - tokens are auto-saved

### Swagger UI

Visit http://localhost:3000/api

### Test Accounts

After running `make seed`, you can login with:

- **Admin**: admin@dronedelivery.com / password123
- **User**: john.doe@example.com / password123
- **Drone**: drone.alpha@dronedelivery.com / password123

## API Overview

### Authentication
- `POST /auth/register` - Create new account
- `POST /auth/login` - Get JWT token

### Orders (User)
- `POST /orders` - Create delivery order
- `GET /orders` - List your orders
- `GET /orders/:id` - Get order details
- `DELETE /orders/:id` - Cancel order

### Drones
- `POST /drones/reserve` - Reserve an order
- `POST /drones/grab` - Start delivery
- `POST /drones/heartbeat` - Update location
- `POST /drones/delivered` - Mark delivered
- `POST /drones/failed` - Report failure
- `POST /drones/broken` - Report breakdown
- `GET /drones/current-order` - Get active order

### Admin
- `GET /admin/orders` - All orders
- `GET /admin/drones` - All drones
- `PUT /admin/orders/:id/origin` - Update pickup location
- `PUT /admin/orders/:id/destination` - Update delivery location
- `POST /admin/drones/:id/mark-broken` - Mark drone broken
- `POST /admin/drones/:id/mark-fixed` - Mark drone fixed

## Environment Variables

Copy `.env.example` to `.env` and the setup command will generate a secure JWT secret for you.

```env
NODE_ENV=development
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=drone_delivery
JWT_SECRET=  # auto-generated by make setup
JWT_EXPIRES_IN=15m
PORT=3000
```

## Running Tests

```bash
make test        # unit tests
make test-e2e    # end-to-end tests
```

Or without Docker:
```bash
npm test
npm run test:e2e
```

## Project Structure

```
src/
├── auth/           # JWT authentication
├── orders/         # Order management
├── drones/         # Drone operations
├── admin/          # Admin controls
├── common/         # Shared guards, decorators
└── prisma/         # Database service

prisma/
├── schema.prisma   # Database schema
├── migrations/     # Migration files
└── seed.ts         # Test data

bruno-collection/   # API tests
├── Auth/
├── Orders/
├── Drones/
└── Admin/
```

## How It Works

1. Users create orders with pickup/delivery locations
2. Drones reserve available orders
3. Drones update their location via heartbeat
4. Orders track drone position and calculate ETA
5. If a drone fails, orders automatically handoff to another drone
6. Admins can view everything and manually intervene

## Database Schema

- **users** - Auth accounts (Admin/User/Drone roles)
- **drones** - Drone fleet with status tracking
- **orders** - Delivery orders with lifecycle
- **order_handoffs** - Failed drone reassignments
- **location_history** - Drone movement tracking
